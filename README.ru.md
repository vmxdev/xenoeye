# xenoeye
Легкий коллектор Netflow

[![Build Status](https://app.travis-ci.com/vmxdev/xenoeye.svg?branch=master)](https://app.travis-ci.com/vmxdev/xenoeye)

С помощью этого коллектора и [Netflow](https://ru.wikipedia.org/wiki/Netflow) вы сможете

  * Видеть трафик IP-сетей, отдельных IP-адресов или сервисов
  * Мониторить сетевой трафик и быстро реагировать на всплески
  * Наблюдать за характером трафика, распределением пакетов используя разные Netflow поля


## Ключевые особенности

Пожалуйста, прочитайте внимательно: некоторые пункты могут быть для вас неприемлемыми

  * Проект находится в бета-состоянии. Коллектор работает у нас, но мы не можем дать никаких гарантий что он будет работать у вас
  * Это не готовое бизнес-решение, а программа-коллектор и несколько вспомогательных скриптов. Тем не менее, с помощью коллектора вы cможете генерировать почти произвольные отчеты, строить графики, дашборды в Grafana и запускать скрипты, когда скорость трафика превышает лимиты
  * Мы используем коллектор для мониторинга своих сетей. У нас используется Netflow v9 и IPFIX, поэтому коллектор поддерживает их. Также поддерживается Netflow v5.
  * В отличие от многих современных коллекторов мы **не используем** Apache Kafka, Elastic стек или что-то подобное. Основные рассчеты происходят внутри самого коллектора
  * В документации есть примеры построения простых отчетов. Для построения более сложных нужно хотя бы базовое знание SQL
  * Коллектор обрабатывает данные двумя способами: агрегирует их за периоды (для получения отчетов и графиков), и использует скользящие средние для быстрой реакции на всплески
  * Оба способа могут использоваться как по отдельности, так и совместно. Например, если с помощью скользящего среднего обнаружилось превышение порога, можно запустить пользовательский скрипт и сразу же включить сбор расширенной статистики
  * Коллектор не очень требователен к ресурсам. Он вполне может обрабатывать данные и строить отчеты даже на Orange Pi (аналог Raspberry Pi) с 4 Гб памяти
  * Ядро коллектора написано на Си
  * Коллектор тестировался только под 64-битным Linux (x64 и AArch64)
  * Мы используем PostgreSQL в качестве хранилища для временных рядов. Туда экспортируются агрегированные по выбранным Netflow-полям данные. Агрегация происходит внутри коллектора
  * Из коробки поддерживается не очень большой набор Netflow-полей, но вы можете добавить почти любое поле. Сейчас поддерживаются поля с типами «целое» (разного размера) и «адрес» (IPv4 и IPv6)
  * У проекта очень либеральная лицензия ISC. У нас нет никаких планов делать коммерческие или частично коммерческие версии. Это значит, что мы не можем дать никаких прогнозов относительно будущего проекта. Но, с другой стороны:
  * В коллекторе нет никаких скрытых или искусственных ограничений


## Производительность

Пользователи обычно интересуются хотя бы приблизительной оценкой производительности, поэтому мы сделали несколько тестов: записали в pcap-файлы реальный Netflow трафик разных роутеров и проиграли их на loopback-интерфейсе с помощью tcpreplay на разной скорости.

Тесты запускались на i3-2120 CPU @ 3.30GHz.

Очень грубо можно ориентироваться на такие цифры:

В отладочном режиме, когда в файл печатается содержимое каждого флова получилось около 100K flow в секунду на одном CPU.

В немного более приближенном к продакшен-режиму, с двумя объектами мониторинга, двумя скользящими окнами - около 700K fps на одном CPU.

Эти цифры лучше читать с пессимистичным настроением:
  1. если вы нагрузите коллектор многими объектами мониторинга с кучей отчетов и отладочной печатью, он может захлебнуться на 100K fps/CPU и меньше
  2. скорее всего 700K fps и больше на одном CPU обсчитать не получится

Про масштабирование на несколько ядер написано ниже в документации


## Документация

  * [Пошаговая инструкция по установке и настойке](STEP-BY-STEP.ru.md)
    * [Сборка и установка](STEP-BY-STEP.ru.md#сборка-и-установка)
    * [Проверяем получение Netflow](STEP-BY-STEP.ru.md#проверяем-получение-netflow)
    * [Распределение нагрузки по нескольким CPU](STEP-BY-STEP.ru.md#распределение-нагрузки-по-нескольким-cpu)
    * [Частота семплирования](STEP-BY-STEP.ru.md#частота-семплирования)
    * [Объекты мониторинга](STEP-BY-STEP.ru.md#объекты-мониторинга)
    * [IP-списки](STEP-BY-STEP.ru.md#ip-cписки)
    * [Конфигурируем какие данные экспортировать в СУБД](STEP-BY-STEP.ru.md#конфигурируем-какие-данные-экспортировать-в-субд)
    * [Экспорт в СУБД](STEP-BY-STEP.ru.md#экспорт-в-субд)
    * [Простые отчеты по IP-адресам](STEP-BY-STEP.ru.md#простые-отчеты-по-ip-адресам)
    * [Можно ли использовать GeoIP?](STEP-BY-STEP.ru.md#можно-ли-использовать-geoip)
    * [Определяем спам-ботов и ssh-сканеры](STEP-BY-STEP.ru.md#определяем-спам-ботов-и-ssh-сканеры)
    * [Строим графики с помощью gnuplot](STEP-BY-STEP.ru.md#строим-графики-с-помощью-gnuplot)
    * [Графики с помощью Python Matplotlib](STEP-BY-STEP.ru.md#графики-с-помощью-python-matplotlib)
    * [Визуализация трафика в Grafana](STEP-BY-STEP.ru.md#визуализация-трафика-в-grafana)
    * [Скользящие средние](STEP-BY-STEP.ru.md#скользящие-средние)
    * [Настройка и установка порогов](STEP-BY-STEP.ru.md#настройка-и-установка-порогов)
    * [Скрипты и их параметры](STEP-BY-STEP.ru.md#скрипты-и-их-параметры)
    * [Расширенная статистика](STEP-BY-STEP.ru.md#расширенная-статистика)
    * [Оповещение об аномалиях с помощью Telegram-робота](STEP-BY-STEP.ru.md#оповещение-об-аномалиях-с-помощью-telegram-робота)

  * [Полное описание конфигурационных файлов](CONFIG.ru.md)
    * [Главный файл конфигурации `xenoeye.conf`](CONFIG.ru.md#главный-файл-конфигурации-xenoeyeconf)
    * [Установка частоты семплирования `devices.conf`](CONFIG.ru.md#установка-частоты-семплирования-devicesconf)
    * [Описание объекта мониторинга `mo.conf`](CONFIG.ru.md#описание-объекта-мониторинга-moconf)
    * [Файлы с порогами](CONFIG.ru.md#файлы-с-порогами)
    * [IP-списки](CONFIG.ru.md#ip-списки)

  * [Внутреннее устройство](INTERNALS.ru.md)
    * [Общие замечания](INTERNALS.ru.md#общие-замечания)
    * [Рабочие и вспомогательные потоки](INTERNALS.ru.md#рабочие-и-вспомогательные-потоки)
    * [Объекты мониторинга и фильтры](INTERNALS.ru.md#объекты-мониторинга-и-фильтры)
    * [Как добавить в коллектор новое Netflow-поле](INTERNALS.ru.md#как-добавить-в-коллектор-новое-netflow-поле)
    * [Источник времени](INTERNALS.ru.md#источник-времени)
    * [Фиксированные временные окна](INTERNALS.ru.md#фиксированные-временные-окна)
    * [Скользящие средние](INTERNALS.ru.md#скользящие-средние)
    * [IP-списки](INTERNALS.ru.md#ip-списки)


## Планы на будущее

Сейчас мы не планируем добавлять новые фичи. Cмотрим на стабильность, результаты работы, пытаемся исправить ошибки и сделать код более простым и понятным

