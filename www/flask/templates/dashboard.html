<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.84.0">
    <title>XE web-view 1.0</title>

    <!-- Bootstrap core CSS -->
    <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>

    
    <!-- Custom styles for this template -->
    <link href="{{ url_for('static', filename='dashboard.css') }}" rel="stylesheet">
  </head>
  <body>
    
<header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
  <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="">XE</a>
  <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <!--  <input class="form-control form-control-dark w-100" type="text" placeholder="Search" aria-label="Search"> -->
  <div class="col-md-3 col-lg-2 me-0 px-3">
    <p class="text-light">{{ g.user['displayname'] }}:
    {{ g.user['description'] }}</p>
  </div>
  <div class="navbar-nav">
    <div class="nav-item text-nowrap">
      <a class="nav-link px-3" href="logout">Sign out</a>
    </div>
  </div>
</header>

<div class="container-fluid">
  <div class="row">
    <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <div class="position-sticky pt-3">

    {% for nav in g.nav %}
      {% set outer_loop = loop %}
        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
          <span>{{ nav.section }}</span>
          <a class="link-secondary" href="#" aria-label="reports">
          </a>
        </h6>
        <ul class="nav flex-column mb-2">
          {% for r in nav.r %}
          <li class="nav-item active">
            <a class="nav-link" href="?mo={{ g.curr_mo.mo_name }}&s={{ outer_loop.index0 }}&r={{ loop.index0 }}">
              {{ r.name }}
            </a>
          </li>
          {% endfor %}
        </ul>
    {% endfor %}

      </div>
    </nav>

    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">

  <label for="exampleDataList" class="form-label">Monitoring object</label>
  <input class="form-control" list="datalistOptions" id="exampleDataList" placeholder="Type to search...">

  <datalist id="datalistOptions">
    {% for mo in g.mo %}
    <option value="{{ mo.mo_name }}">{{ mo.mo_display }}</option>
    {% endfor %}
  </datalist>

</div>

      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">{{ g.r.name }}</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
          <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">
            6 hours
          </button>
        </div>
      </div>

{% for ch in g.r.charts %}
      <div class="d-flex align-items-center justify-content-center" id="gd{{ loop.index0 }}-load">
        <!--<strong>Loading...</strong>-->
        <div class="spinner-border ml-auto" role="status" aria-hidden="true"></div>
      </div>
      <div id="gd{{ loop.index0 }}"></div>
{% endfor %}
<!--
      <h2>Anomalies</h2>
      <div class="table-responsive">
        <table class="table table-striped table-sm">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Active</th>
              <th scope="col">Start time</th>
              <th scope="col">End time</th>
              <th scope="col">Type</th>
              <th scope="col">Monitoring object</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1,001</td>
              <td>random</td>
              <td>data</td>
              <td>placeholder</td>
              <td>text</td>
              <td>text</td>
            </tr>
            <tr>
              <td>1,002</td>
              <td>placeholder</td>
              <td>irrelevant</td>
              <td>visual</td>
              <td>layout</td>
              <td>layout</td>
            </tr>
          </tbody>
        </table>
      </div>
-->
    </main>
  </div>
</div>

    <script src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='plotly.min.js') }}"></script>
    <script>
function xe_chart_gen_color(stringInput) {
	let hash = [...stringInput].reduce((acc, char) => {
		return char.charCodeAt(0) + ((acc << 5) - acc);
	}, 0);
	let hue = hash % 360; // 0..360
	let saturation = 40 + hash % (100 - 40); // 40..100%
	let lightness = 10 + hash % (50-10); //10..50%
	return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
}

function xe_chart_format_v(pps_bps, v) {
	let ret = "";

	if (pps_bps == 2) {
		const byteValueNumberFormatter = Intl.NumberFormat("en", {
			notation: "compact",
			style: "unit",
			unit: "bit",
			unitDisplay: "narrow",
		});
		ret = byteValueNumberFormatter.format(v * 8);
	} else {
		const byteValueNumberFormatter = Intl.NumberFormat("en", {
			notation: "compact",
			style: "decimal",
			unitDisplay: "narrow",
		});
		ret = byteValueNumberFormatter.format(v);
	}

	return ret;
}

function xe_chart_ts_grid(chart, params) {
	let ns = "http://www.w3.org/2000/svg";

	/* horizontal grid */
	let n_lines = 7;

	let y = 100.0 - params.gap_bottom;
	let dh = (y - params.gap_top) / n_lines;

	let val_h = 0;
	let dval_h = chart.max_val / n_lines;

	const text_started_at = 5;

	for (let i=0; i<(n_lines + 1); i++) {
		y_p = y.toString() + '%';
		const rect = document.createElementNS(ns, 'line');
		rect.setAttribute('x1', (params.gap_left - text_started_at + 2).toString() + '%');
		rect.setAttribute('y1', y_p);
		rect.setAttribute('x2', '100%');
		rect.setAttribute('y2', y_p);
		rect.setAttribute('style', 'stroke:rgba(200,200,200,0.5);stroke-width:1');
		chart.svg.appendChild(rect);

		const cap = document.createElementNS(ns, 'text');
		cap.setAttribute('x', text_started_at + '%');
		cap.setAttribute('y', y_p);
		cap.setAttribute('textLength', '3%');
		cap.setAttribute('lengthAdjust', 'spacingAndGlyphs');
		cap.setAttribute('style', 'white-space: pre');
		//cap.setAttribute('style', 'font-family:monospace');
		//cap.setAttribute('text-anchor', 'end');
		cap.setAttribute('dominant-baseline', 'middle');
		cap.setAttribute('text-anchor', 'middle');

		let val_str = xe_chart_format_v(chart.pps_bps, val_h);
		let val_str_pad = (val_str.toString()).padStart(6, ' ');
		const txt = document.createTextNode(val_str_pad);
		cap.appendChild(txt);
		chart.svg.appendChild(cap);
		y -= dh;
		val_h += dval_h;
	}

	/* vertical grid */
	n_lines = 7;
	let x = params.gap_left;//(100.0 * (i + 1) / n_lines).toString() + '%';
	let date_len = 5;
	let time_len = 3;
	let dx = (100 - params.gap_left - date_len / 2) / n_lines;
	for (let i=0; i<(n_lines+1); i++) {
		let x_p = x.toString() + '%';
		const rect = document.createElementNS(ns, 'line');
		rect.setAttribute('x1', x_p);
		rect.setAttribute('y1', '0%');
		rect.setAttribute('x2', x_p);
		rect.setAttribute('y2', '93%');
		rect.setAttribute('style', 'stroke:rgba(200,200,200,0.5);stroke-width:1');
		chart.svg.appendChild(rect);

		let ep = chart.ep_min + (chart.ep_max - chart.ep_min) * i / n_lines;
		let ep_d = new Date(ep * 1000);
		const cap = document.createElementNS(ns, 'text');
		cap.setAttribute('x', x_p);
		cap.setAttribute('y', '97%');
		cap.setAttribute('textLength', date_len + '%');
		cap.setAttribute('lengthAdjust', 'spacingAndGlyphs');
		cap.setAttribute('style', 'white-space: pre');
		cap.setAttribute('dominant-baseline', 'middle');
		cap.setAttribute('text-anchor', 'middle');

		let val = ep_d.toLocaleDateString();
		const txt_date = document.createTextNode(val);
		cap.appendChild(txt_date);

		const cap1 = document.createElementNS(ns, 'text');
		cap1.setAttribute('x', x_p);
		cap1.setAttribute('y', '93%');
		cap1.setAttribute('textLength', time_len + '%');
		cap1.setAttribute('lengthAdjust', 'spacingAndGlyphs');
		cap1.setAttribute('style', 'white-space: pre');
		cap1.setAttribute('dominant-baseline', 'middle');
		cap1.setAttribute('text-anchor', 'middle');

		val = ep_d.toLocaleTimeString();
		const txt_time = document.createTextNode(val);
		cap1.appendChild(txt_time);

		chart.svg.appendChild(cap);
		chart.svg.appendChild(cap1);
		x += dx;
	}
}

function xe_chart_ts_make_maps(chart, skip) {
	chart.t_map = new Map();
	chart.p_map = new Map();

	chart.max_val = 0.0;
	chart.ep_min = Number.MAX_SAFE_INTEGER;
	chart.ep_max = 0;

	chart.ep_min_dist = Number.MAX_SAFE_INTEGER;

	let ep_prev = 0;
	for (let i=0; i<chart.data.length; i++) {
		let ep = chart.data[i][0];
		let val = chart.data[i][chart.pps_bps]; // bps/pps
		let param = chart.data[i][3];

		if (ep < chart.ep_min) {
			chart.ep_min = ep;
		}
		if (ep > chart.ep_max) {
			chart.ep_max = ep;
		}
		if (ep_prev == 0) {
			ep_prev = ep;
		} else if (ep_prev != ep) {
			let dist = Math.abs(ep - ep_prev);
			if (chart.ep_min_dist > dist) {
				chart.ep_min_dist = dist;
			}
		}

		if (skip) {
			if (chart.exclude.has(param.toString())) {
				/* skip */
				continue;
			}
		}

		if (chart.t_map.has(ep)) {
			if (chart.t_map.get(ep).m.has(param)) {
				let v = chart.t_map.get(ep).m.get(param);
				v += val;
				chart.t_map.get(ep).m.set(param, v);
			} else {
				chart.t_map.get(ep).m.set(param, val);
			}

			chart.t_map.get(ep).sum += val;
		} else {
			let item = {sum: val, m: new Map()};
			item.m.set(param, val);
			chart.t_map.set(ep, item);
		}

		if (chart.t_map.get(ep).sum > chart.max_val) {
			chart.max_val = chart.t_map.get(ep).sum;
		}

		if (chart.p_map.has(param)) {
			if (val < chart.p_map.get(param).min) {
				chart.p_map.get(param).min = val;
			}
			if (val > chart.p_map.get(param).max) {
				chart.p_map.get(param).max = val;
			}
			chart.p_map.get(param).sum += val;
		} else {
			let item = {min: val, max: val, sum: val};
			chart.p_map.set(param, item);
		}
	}

	/* sort */
	chart.t_map.forEach(function(value, key) {
		value.sorted = new Map([...value.m.entries()].sort());
	});
}

function xe_chart_ts_redraw(chart) {
	let ns = "http://www.w3.org/2000/svg";

	/* remove all from svg */
	while (chart.svg.firstChild !== null) {
		chart.svg.removeChild(chart.svg.firstChild);
	}

	let gap_bottom = 10.0;
	let gap_top = 3.0;
	let gap_left = 10.0;

	xe_chart_ts_grid(chart,
		{gap_top: gap_top,
		gap_bottom: gap_bottom,
		gap_left: gap_left});

	let ep_w = chart.ep_max - chart.ep_min;

	let h_range = 100.0 - gap_bottom - gap_top;
	let w_range = 100.0 - gap_left;

	let bar_w = (w_range - 10.0) * chart.ep_min_dist / ep_w; /* bar width in percents */

	chart.t_map.forEach(function(value, ep) {
		let k = (ep - chart.ep_min) / ep_w;
		let x_shift = -k * bar_w;
		let x = w_range * k + gap_left + x_shift;
		let y = 0;
		let datetime_str = ' (' + (new Date(ep * 1000)).toLocaleString() + ')';
 
		value.sorted.forEach(function(n, param) {
			let h = 0.0;
			if (chart.max_val > 0) {
				h = h_range * n / chart.max_val;
			}

			const rect = document.createElementNS(ns, 'rect');
			rect.setAttribute('x', x.toString() + '%');
			rect.setAttribute('y', ((100.0 - gap_bottom) - (y + h)).toString() + '%');
			rect.setAttribute('width', bar_w.toString() + '%');
			rect.setAttribute('height', h.toString() + '%');
			rect.setAttribute('fill', xe_chart_gen_color(param.toString()));

			const title = document.createElementNS(ns, 'title');

			const hint = document.createTextNode(param.toString() + ' - ' + xe_chart_format_v(chart.pps_bps, n) + datetime_str);
			title.appendChild(hint);

			rect.appendChild(title);
			chart.svg.appendChild(rect);

			y += h;
		});
	});
}

function xe_chart_ts_update(chart, cb) {
	if (!cb.checked) {
		chart.exclude.add(cb.dataset.param);
	} else {
		chart.exclude.delete(cb.dataset.param);
	}
	xe_chart_ts_make_maps(chart, true);
	xe_chart_ts_redraw(chart);
}

function xe_chart_ts_ppsbps_switch(chart, idx, ppsbps) {
	chart.pps_bps = ppsbps;
	xe_chart_ts_make_maps(chart, true);
	xe_chart_ts_redraw(chart);

	xe_chart_ts_make_maps(chart, false);
	xe_chart_tables_redraw(chart, idx);
}

function xe_chart_tables_redraw(chart, idx) {
	let n_tables = 4;

	let n_rows = Math.trunc(chart.p_map.size / n_tables);
	if ((chart.p_map.size % n_tables) > 0) {
		n_rows++;
	}

	let tab_head = `
		<div class="col">
		<table class="table table-sm table-hover table-bordered">
			<thead>
				<tr>
					<th scope="col">~</th>
					<th scope="col">avg</th>
					<th scope="col">max</th>
					<th scope="col">min</th>
				</tr>
			</thead>
			<tbody>	`;

	let tab_foot = `</tbody>
		</table>
		</div>
		`;
	let html = tab_head;

	let p_map_sorted = new Map([...chart.p_map.entries()].sort());
	let cnt = 0;
	p_map_sorted.forEach(function(value, param) {
		let id = "param" + idx.toString() + cnt.toString();
		let color = xe_chart_gen_color(param.toString());
		let evt = "xe_chart_ts_update(window.xe_chart" + idx + ", this);";
		let checked = "checked";
		if (chart.exclude.has(param.toString())) {
			checked = "";
		}
		tab_row = `
			<tr>
			<th scope="row">
			<div class="form-check">
				<input class="form-check-input" type="checkbox" value="" data-param="` + param + `"id="` + id + `" onclick="` + evt + `" ${checked}>
				<label class="form-check-label" for="` + id + `" style="color:${color}">
					` + param + `
				</label>
			</div>
			</th>
			<td>` + xe_chart_format_v(chart.pps_bps, value.sum / chart.t_map.size) + `</td>
			<td>` + xe_chart_format_v(chart.pps_bps, value.max) + `</td>
			<td>` + xe_chart_format_v(chart.pps_bps, value.min) + `</td>
			</tr>`;

		html += tab_row;
		cnt++;

		if (cnt == p_map_sorted.size) {
			html += tab_foot;
		} else if ((cnt % n_rows) == 0) {
			html += tab_foot;
			html += tab_head;
		}
	});

	const d = document.getElementById('cap' + idx);
	d.innerHTML = html;
}

{% for ch in g.r.charts %}
{% if ch["type"] == "ttl" %}
fetch('/lk/r.data?mo={{ g.curr_mo.mo_name }}&s={{ g.curr_section }}&r={{ g.curr_rep }}&c={{ loop.index0 }}')
  .then((response) => response.json())
  .then((data) => {
		var time = data.map( ([ t, pkts, octs ]) => (new Date(t * 1000)) );
		var pkts = data.map( ([ t, pkts, octs ]) => (pkts) );
		var octs = data.map( ([ t, pkts, octs ]) => (octs * 8) );

		var pps = {
			x: time,
			y: pkts,
			name: 'PPS',
			type: 'bar'
		};
		var bps = {
			x: time,
			y: octs,
			yaxis: 'y2',
			name: 'BPS',
			type: 'bar'
		};

		var data = [pps, bps];

		var layout = {
			title: {text: '{{ ch.name }}'},
			showlegend: true,
			legend: {"orientation": "h"},
			yaxis: {
				title: {
					text: 'PPS'
				}
			},
			yaxis2: {
				title: {
					text: 'BPS',
					font: {color: 'rgb(148, 103, 189)'}
				},
				tickfont: {color: 'rgb(148, 103, 189)'},
				overlaying: 'y',
				side: 'right'
			}
		};

		Plotly.newPlot('gd{{ loop.index0 }}', data, layout);
		let spinner = document.getElementById("gd{{ loop.index0 }}-load");
		spinner.style.visibility = 'hidden';
  })
  .catch(console.error);
{% endif %}
{% if ch["type"] == "v" %}
fetch('/lk/r.data?mo={{ g.curr_mo.mo_name }}&s={{ g.curr_section }}&r={{ g.curr_rep }}&c={{ loop.index0 }}')
  .then((response) => response.json())
  .then((data) => {
		var time = data.map( ([ t, pkts, octs, proto ]) => (new Date(t * 1000)) );
		var proto = data.map( ([ t, pkts, octs, proto ]) => (proto) );
		var uniq_proto = Array.from(new Set(data.map( ([ t, pkts, octs, proto ]) => (proto) )));

		var plot_data = [];
		uniq_proto.forEach((item) => {
			var prot_v = data.map(([ t, pkts, octs, proto ]) => {
				if (proto === item) {
					return pkts;
				} else {
					return 0;
				}
			});

			var bps = {
				x: time,
				y: prot_v,
				name: '{{ ch["cap"] }} ' + item,
				type: 'bar'
			};
			plot_data.push(bps);
		});

		var layout = {
			title: {text: '{{ ch["name"] }}'},
			showlegend: true,
			legend: {"orientation": "h"},
			barmode: 'stack',
			yaxis: {
				title: {
					text: 'PPS'
				}
			}
		};

		Plotly.newPlot('gd{{ loop.index0 }}', plot_data, layout);
		let spinner = document.getElementById("gd{{ loop.index0 }}-load");
		spinner.style.visibility = 'hidden';
  })
  .catch(console.error);
{% endif %}
{% if ch["type"] == "tbl" %}
fetch('/lk/r.data?mo={{ g.curr_mo.mo_name }}&s={{ g.curr_section }}&r={{ g.curr_rep }}&c={{ loop.index0 }}')
  .then((response) => response.json())
  .then((data) => {
		var time = data.map( ([ t, pkts, octs, proto ]) => (new Date(t * 1000)) );
		var proto = data.map( ([ t, pkts, octs, proto ]) => (proto) );
		var uniq_proto = Array.from(new Set(data.map( ([ t, pkts, octs, proto ]) => (proto) )));


		let spinner = document.getElementById("gd{{ loop.index0 }}-load");
		spinner.style.visibility = 'hidden';
  })
  .catch((err) => {
		let doc = document.getElementById("gd{{ loop.index0 }}");
		doc.innerHTML = "<h5>{{ ch["name"] }}</h5><div>No data</div>";
		let spinner = document.getElementById("gd{{ loop.index0 }}-load");
		spinner.style.visibility = 'hidden';
});
{% endif %}
{% if ch["type"] == "svg" %}
fetch('/lk/r.data?mo={{ g.curr_mo.mo_name }}&s={{ g.curr_section }}&r={{ g.curr_rep }}&c={{ loop.index0 }}')
  .then((response) => response.json())
  .then((data) => {
		//window.xe_chart_data{{ loop.index0 }} = data;
		window.xe_chart{{ loop.index0 }} = {};
		window.xe_chart{{ loop.index0 }}.data = data;

		let ns = "http://www.w3.org/2000/svg";
		window.xe_chart{{ loop.index0 }}.svg = document.createElementNS(ns, "svg");
		const w = 1000, h = 400;
		window.xe_chart{{ loop.index0 }}.svg.setAttributeNS(null, 'width', '100%');
		//svg.setAttributeNS(null, 'height', '100%');
		window.xe_chart{{ loop.index0 }}.svg.setAttributeNS(null, 'height', h);

		let elem = document.getElementById("gd{{ loop.index0 }}");
		elem.appendChild(window.xe_chart{{ loop.index0 }}.svg);

		window.xe_chart{{ loop.index0 }}.exclude = new Set();

		window.xe_chart{{ loop.index0 }}.pps_bps = 2;
		xe_chart_ts_make_maps(window.xe_chart{{ loop.index0 }}, true);
		xe_chart_ts_redraw(window.xe_chart{{ loop.index0 }});

		let title = `
			<h4 class="text-center">{{ ch["name"] }}</h4>
			`;
		let bps_pps_switch = `
			<div class="mb-4">
				<input type="radio" class="btn-check" name="pbps{{ loop.index0 }}" id="bps{{ loop.index0 }}" autocomplete="off" checked
					onclick="xe_chart_ts_ppsbps_switch(window.xe_chart{{ loop.index0 }}, {{ loop.index0 }}, 2);">
				<label class="btn btn-outline-success" for="bps{{ loop.index0 }}">BPS</label>
				<input type="radio" class="btn-check" name="pbps{{ loop.index0 }}" id="pps{{ loop.index0 }}" autocomplete="off"
					onclick="xe_chart_ts_ppsbps_switch(window.xe_chart{{ loop.index0 }}, {{ loop.index0 }}, 1);">
				<label class="btn btn-outline-success" for="pps{{ loop.index0 }}">PPS</label>
			</div>`;

		elem.insertAdjacentHTML('beforebegin', title + bps_pps_switch);

		let cap_head = `
			<div class="container">
				<div class="row" id="cap{{ loop.index0 }}">
			`;
		let cap_foot = '</div></div>';

		elem.insertAdjacentHTML('afterend', cap_head + cap_foot);

		xe_chart_tables_redraw(window.xe_chart{{ loop.index0 }}, {{ loop.index0 }});

		let spinner = document.getElementById("gd{{ loop.index0 }}-load");
		spinner.style.visibility = 'hidden';
  })
  .catch(console.error);
{% endif %}
{% endfor %}
    </script>
  </body>
</html>
