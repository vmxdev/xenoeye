# Полное описание конфигурационных файлов

  * [Главный файл конфигурации `xenoeye.conf`](#главный-файл-конфигурации-xenoeyeconf)
  * [Установка частоты семплирования `devices.conf`](#установка-частоты-семплирования-devicesconf)
  * [Описание объекта мониторинга `mo.conf`](#описание-объекта-мониторинга-moconf)

## Общая информация

Конфигурация состоит из двух общих конфигурационных файлов и нескольких файлов, которые описывают объекты мониторинга.

Конфигурационные файлы в `xenoeye` — это JSON, в котором разрешены комментарии.

Допускаются два типа комментариев: однострочные, начинаются с `//` и продолжаются до конца строки и многострочные, начинаются с `/*` и заканчиваются `*/`

При чтении конфигов неизвестные ключи игнорируются

### Главный файл конфигурации `xenoeye.conf`

Файл состоит из таких разделов:

```
{
	"capture": [
		{"socket": {"listen-on": "*", "port": "2055"}},
		{"pcap" : {"interface": "eth0", "filter": "udp and port 2055"}}
	],

	"templates": {
		"db": "/var/lib/xenoeye/templates.tkvdb"
	},

	"debug": {
		/* allowed values: "none", "syslog", "/path/to/file.txt" */
		"dump-flows": "none"
	},

	"devices": "/etc/xenoeye/devices.conf",

	"mo-dir": "/var/lib/xenoeye/mo"
}
```

#### Секция `capture`

Каждый элемент из массива описывает поток обработки netflow.

Коллектор может захватывать netflow-пакеты двумя способами: обычным интерфейсом сокетов и с помощью pcap

`socket` — обычный интерфейс сокетов. Параметры - адрес на котором слушать и порт

`pcap` — захват netflow-пакетов с помощью библиотеки libpcap. Параметры - название интерфейса, на котором захватывать netflow и BPF-фильтр.

BPF-фильтр может быть пустым, тогда коллектор будет пытаться парсить все UDP-пакеты на этом интерфейсе.

Рабочий поток захватывает только те пакеты, которые матчатся фильтром.


#### Секция `templates`

В этой секции можно указать файл, в котором хранятся netflow-шаблоны. Шаблоны хранятся на диске, после старта коллектор читает их и может сразу декодировать фловы.

Для того, чтобы различать устройства, используется комбинацию IP адреса источника netflow (роутера) плюс ID источника.


#### Секция `debug`

Коллектор может печатать для отладки содержимое декодированных фловов. В зависимости от значения `"dump-flows"` он может печатать в syslog + stderr или в файл.

Если выбрана печать в syslog, сообщения дополнительно выводятся в stderr (`LOG_PERROR`). Facility = `LOG_USER`, level = `LOG_DEBUG`.

При печати в файл используется буферизация, данные появляются в файле не сразу, а через время и блоками


#### Ключи `devices` и `mo-dir`

Указывают на файл с частотой семплирования и каталог с объектами мониторинга (см. ниже)



### Установка частоты семплирования `devices.conf`

Коллектор (по крайней мере сейчас) не читает данные о частоте семплирования из option template. Для установки частоты нужно записать ее в файл `devices.conf`.

Пример файла:

```
[
	{
		"ip": "127.0.0.1",
		"id": 0,
		"sampling-rate": 1
	},
	{
		"ip": "1.2.3.4",
		"sampling-rate": 1000
	}
	/* ... */
]
```

`ip` - адрес устройства, `id` - его идентификатор. Если включить отладочную печать фловов, то IP, ID и частота семплирования устройства будет печататься в конце каждого флова


### Описание объекта мониторинга `mo.conf`

В каталоге с объектами мониторинга находятся подкаталоги с файлами `mo.conf`. Это описание объекта мониторинга.

Пример файла:
```{
	"filter": "dst net mynet",

	"debug": {
		"dump-flows": "none"
	},

	"mavg": [
		{
			"name": "mavg1",
			"time": "10",
			"dump": "10",
			"fields": ["dst host", "packets"],
			"overlimit": [
					{
						"name": "level1",
						"limits": "limits1.csv",
						"default": [100000],
						"action-script": "/var/lib/xenoeye/scripts/act.sh",
						"back2norm-time": 5,
						"back2norm-script": "/var/lib/xenoeye/scripts/back.sh"
						"ext": ["ext", "other_mo/ext"]
					}
			]
		}
	]

	,

	"fwm": [
		{
			"name": "fw1",
			"fields": ["src host", "packets desc", "octets desc"]
			"time": 15,
			"limit": 5
		},
		{
			"extended": true,
			"name": "ext",
			"fields": ["octets desc", "src host", "dst host", "proto"]
			"time": 5,
			"limit": 100
		}
	]
}
```

#### Ключ `filter`

Правило на BPF-подобном языке, которое описывает этот объект мониторинга. В правиле могут быть использованы любые netflow-поля, которые известны системе.

Допускается пустой фильтр, в этом случае в объект мониторинга попадут все фловы.

Синтаксис фильтра:
```
filter = IP_ADDR_FIELD_NAME <IPv4/IPv6 ADDR>    /* одиночный адрес */

filter = IP_ADDR_FIELD_NAME <ADDR_LIST_FILE>    /* файл со списком адресов */

filter = INT_FIELD_NAME INT_VAL                 /* одиночное значение */

filter = INT_FIELD_NAME INT_VAL_MIN-INT_VAL_MAX /* диапазон значений */

filter = FIELD_NAME V1 or V2 or V3 ...          /* перечисление нескольких возможных значений */


filter = NOT <expr>  /* инверсия условия */

filter = <expr1> AND <expr2> AND <expr3> ...    /* несколько условий, которые должны выполняться одновременно */

filter = <expr1> OR <expr2> OR <expr3> ...      /* несколько условий, должно выполняться хотя бы одно */

filter = <expr1> AND (<expr2> OP <expr3>)       /* приоритет AND выше чем у OR, скобки могут изменять приоритет */

```

Часть полей может иметь префикс `src` или `dst` (например, `src as` или `dst host`). Если префикс не указан, то будет использоваться как dst так и src.

У полей IPv6 есть суффикс `6` - `host6`/`net6`.

Примеры:

`dst net my-net` - трафик с IP назначения из списка `my-net`

`net bogon-net` - фильтр отберет фловы у которых или `IPV4_SRC_ADDR` или `IPV4_DST_ADDR` принадлежат bogon-сетям

`src net6 bogon-net and dst net6 bogon-net` - трафик у которого одновременно и src IPv6 и dst IPv6 принадлежат bogon-сетям

`dst as 12345 and not (dst host 1.2.3.4 or 2.3.4.5 or 3.4.5.6)` - фловы у которых dst автономная система 12345, исключая несколько адресов

Текущий список netflow-полей: [`filter.def`](filter.def)

См. также "добавление..."

#### Секция `debug`

Допускаются те же значения, что и в секции `debug` главного конфигурационного файла.

Но в отличие от общей отладки, будут печататься только фловы, которые принадлежат данному объекту монторинга

#### Секция `fwm`

Массив, описывающий несколько временны́х окон фиксированного размера.

Описание ключей:

`name`: имя окна и таблицы в PostgreSQL, в которую будут экспортироваться данные. Допускаются имена в UTF8. В этом случае в запросах имя таблицы нужно будет брать в кавычки

`fields`: массив netflow-полей, которые будут экспортироваться

`time`: размер окна (время в секундах)

`limit`: сколько экспортировать записей за один раз


#### Секция `mavg`

Массив, описывающий несколько скользящих средних.

Описание ключей:

"name": "mavg1",

Используется при запуске скриптов (передается как один из параметров)

"time": "10",
"dump": "10",
"fields": ["dst host", "packets"],
Список полей

`overlimit`: массив, описывающий превышение порогов.

```
		{
						"name": "level1",
						"limits": "limits1.csv",
						"default": [100000],
						"action-script": "/var/lib/xenoeye/scripts/act.sh",
						"back2norm-time": 5,
						"back2norm-script": "/var/lib/xenoeye/scripts/back.sh"
						"ext": ["ext", "other_mo/ext"]
					}
			]
		}
	]
```
